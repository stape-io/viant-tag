___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Viant Conversion API",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "CONVERSIONS"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Tag that sends events to Viant Data Platform (VDP) Connect API using the Conversion API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "baseConfigGroup",
    "subParams": [
      {
        "type": "RADIO",
        "name": "eventType",
        "displayName": "Event Name Setup Method",
        "radioItems": [
          {
            "value": "standard",
            "displayValue": "Standard",
            "subParams": [
              {
                "type": "SELECT",
                "name": "eventNameStandard",
                "selectItems": [
                  {
                    "value": "PageView",
                    "displayValue": "PageView"
                  },
                  {
                    "value": "LandingPage",
                    "displayValue": "LandingPage"
                  },
                  {
                    "value": "ItemView",
                    "displayValue": "ItemView"
                  },
                  {
                    "value": "AddToCart",
                    "displayValue": "AddToCart"
                  },
                  {
                    "value": "InitiateCheckout",
                    "displayValue": "InitiateCheckout"
                  },
                  {
                    "value": "AddPaymentInfo",
                    "displayValue": "AddPaymentInfo"
                  },
                  {
                    "value": "Purchase",
                    "displayValue": "Purchase"
                  },
                  {
                    "value": "Lead",
                    "displayValue": "Lead"
                  }
                ],
                "simpleValueType": true,
                "defaultValue": "PageView",
                "displayName": "Event Name",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "alwaysInSummary": true
              }
            ]
          },
          {
            "value": "inherit",
            "subParams": [],
            "displayValue": "Inherit from client",
            "help": "If the request follows the \u003cb\u003eGoogle Analytics 4 (GA4)\u003c/b\u003e schema, the following mappings will be applied to convert GA4 \u003ci\u003eEvent Names\u003c/i\u003e into the Viant Conversion API \u003ci\u003eConversion Event Type\u003c/i\u003e equivalent:\n\u003cbr/\u003e\u003cbr/\u003e \n\u003cul\u003e \n\u003cli\u003epage_view → PageView\u003c/li\u003e \n\u003cli\u003eview_item → ItemView\u003c/li\u003e\n\u003cli\u003eadd_to_cart → AddToCart\u003c/li\u003e\n\u003cli\u003ebegin_checkout → InitiateCheckout\u003c/li\u003e\n\u003cli\u003eadd_payment_info → AddPaymentInfo\u003c/li\u003e\n\u003cli\u003egenerate_lead → Lead\u003c/li\u003e\n\u003cli\u003epurchase → Purchase\u003c/li\u003e\n\u003c/ul\u003e\n\u003cbr/\u003e\nPlease note that it provides partial event mapping. Not all GA4 events can be mapped to Viant Conversion API events."
          },
          {
            "value": "custom",
            "subParams": [
              {
                "type": "TEXT",
                "name": "eventNameCustom",
                "displayName": "Event Name",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "displayValue": "Custom",
            "help": ""
          }
        ],
        "simpleValueType": true,
        "defaultValue": "standard"
      },
      {
        "type": "TEXT",
        "name": "accountId",
        "displayName": "Viant Account ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "POSITIVE_NUMBER"
          }
        ],
        "help": "The Viant Account ID associated with your account.",
        "valueHint": "2222"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "advertiserIds",
        "displayName": "Viant Advertiser IDs",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "ID",
            "name": "id",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ],
            "valueHint": "69757"
          }
        ],
        "newRowButtonText": "Add Advertiser ID",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "The Viant Advertiser IDs associated with your account."
      },
      {
        "type": "TEXT",
        "name": "authUsername",
        "displayName": "Conversion API Username",
        "simpleValueType": true,
        "help": "The username provided by Viant to be used in the Conversion API.\n\u003cbr/\u003e\nContact your Account Manager to obtain it.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "authPassword",
        "displayName": "Conversion API Password",
        "simpleValueType": true,
        "help": "The password provided by Viant to be used in the Conversion API.\n\u003cbr/\u003eContact your Account Manager to obtain it.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "useOptimisticScenario",
        "displayName": "Use Optimistic Scenario",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not.",
        "defaultValue": false
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "serverEventDataGroup",
    "displayName": "Server Event Data Parameters",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "LABEL",
        "name": "serverEventDataGroupLabel",
        "displayName": "Check these help pages \u003ca href\u003d\"https://docs.api.viantinc.com/reference/onboard-onlineoffline-conversion-data\"\u003e[1]\u003c/a\u003e and \u003ca href\u003d\"https://docs.api.viantinc.com/v1.1/reference/post_v1-conversions\"\u003e[2]\u003c/a\u003e for a description of each \u003ci\u003eServer Event Data Parameters\u003c/i\u003e and its expected type and value."
      },
      {
        "type": "SELECT",
        "name": "autoMapServerEventDataParameters",
        "displayName": "Auto-map Server Event Data Parameters",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "If enabled, the tag will attempt to automatically map parameters from the Event Data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eConversion Timestamp: ISO 8601 timestamp of when the server tag fired\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "serverEventDataList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "conversionTimestamp",
                "displayValue": "Conversion Timestamp (ISO 8601 format or UNIX timestamp in milliseconds)"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": []
          }
        ],
        "newRowButtonText": "Add Parameter",
        "displayName": "Server Event Data Parameters",
        "help": ""
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "userIdentifiersParametersGroup",
    "displayName": "User Identifiers Parameters",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "LABEL",
        "name": "userIdentifiersParametersGroupLabel",
        "displayName": "Check these help pages \u003ca href\u003d\"https://docs.api.viantinc.com/reference/onboard-onlineoffline-conversion-data\"\u003e[1]\u003c/a\u003e, \u003ca href\u003d\"https://docs.api.viantinc.com/v1.1/reference/post_v1-conversions\"\u003e[2]\u003c/a\u003e and \u003ca href\u003d\"https://docs.api.viantinc.com/reference/prepaing-your-user-data#physical-address-sha256-hashing\"\u003e[3] (User Physical Address formatting and normalization guidelines)\u003c/a\u003e for a description of each \u003ci\u003eUser Identifiers Parameters\u003c/i\u003e and its expected type and value.\n\u003cbr/\u003e\n\u003cb\u003eAt least 1 entry is required, either auto-mapped or manual.\u003c/b\u003e\n\u003cbr/\u003e"
      },
      {
        "type": "SELECT",
        "name": "autoMapUserIdentifiersParameters",
        "displayName": "Automap User Identifiers Parameters",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "If enabled, the tag will attempt to automatically map parameters from your event data. \n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eEmail: \u003ci\u003eeventData.email \u003e eventData.email_address \u003e eventData.userData.email \u003e eventData.userData.email_address \u003e eventData.userData.sha256_email_address\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eIP Address: \u003ci\u003eeventData.ip_override\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eMobile ID: (iOS IDFA and Android GAID/AAID) \u003ci\u003eeventData[\u0027x-ga-resettable_device_id\u0027]\u003c/i\u003e or (iOS IDFV, if IDFA is not available) \u003ci\u003eeventData[\u0027x-ga-vendor_device_id\u0027]\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "userIdentifiersParametersList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": false,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "email_sha256",
                "displayValue": "Email Address (if not SHA256 hashed, it will be automatically hashed)"
              },
              {
                "value": "phonenumber_sha256",
                "displayValue": "Phone Number (if not SHA256 hashed, it will be automatically hashed)"
              },
              {
                "value": "ip",
                "displayValue": "IP Address"
              },
              {
                "value": "mobile_id",
                "displayValue": "Mobile ID (iOS IDFA/IDFV or Android AAID/GAID)"
              },
              {
                "value": "address_sha256",
                "displayValue": "User Physical Address (if not SHA256 hashed, it will be automatically hashed)"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": []
          }
        ],
        "newRowButtonText": "Add Parameter",
        "help": "All of the fields can receive an array the corresponding identifier or only a single item.\n\u003cbr/\u003e\nExample: \n\u003c/br\u003e[\"foo@example.com\", \"bar@example.net\"] or \"abc@example.org\"\n\u003cbr/\u003e\n\u003cbr/\u003e\n\u003cb\u003ePhone Number\u003c/b\u003e expected format:\n\u003cul\u003e\n\u003cli\u003eNo country code\u003c/li\u003e\n\u003cli\u003eNo \"+\" sign in front of the number\u003c/li\u003e\n\u003cli\u003eOnly digits (no hyphens, no parenthesis etc.)\u003c/li\u003e\n\u003c/ul\u003e",
        "displayName": "User Identifiers Parameters"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "eventParametersGroup",
    "displayName": "Event Parameters",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "LABEL",
        "name": "eventParametersGroupLabel",
        "displayName": "Check these help pages \u003ca href\u003d\"https://docs.api.viantinc.com/reference/onboard-onlineoffline-conversion-data\"\u003e[1]\u003c/a\u003e and \u003ca href\u003d\"https://docs.api.viantinc.com/v1.1/reference/post_v1-conversions\"\u003e[2]\u003c/a\u003e for a description of \u003ci\u003eEvent Data Parameters\u003c/i\u003e.\n\u003cbr/\u003e"
      },
      {
        "type": "SELECT",
        "name": "autoMapEventParameters",
        "displayName": "Automap Event Parameters",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "true"
          },
          {
            "value": false,
            "displayValue": "false"
          }
        ],
        "simpleValueType": true,
        "help": "If enabled, the tag will attempt to automatically map parameters from your event data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eTransaction ID: \u003ci\u003eeventData.transaction_id\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eAmount: \u003ci\u003eeventData.value \u003e Sum of eventData.items Price * Quantity\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eCurrency: \u003ci\u003eeventData.currency \u003e Currency from eventData.items\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003ePurchased Items: \u003ci\u003eeventData.items\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true,
        "subParams": [
          {
            "type": "TEXT",
            "name": "itemIdKey",
            "displayName": "Custom Item ID Key",
            "simpleValueType": true,
            "help": "Optional.\n\u003cbr/\u003e\u003cbr/\u003e\nYou can specify a custom key, which will be used to set the content Item ID, by default \u003ci\u003eitem_id\u003c/i\u003e will be used. This may be useful if you are using WooCommerce extensions.",
            "canBeEmptyString": true,
            "enablingConditions": [
              {
                "paramName": "autoMapEventParameters",
                "paramValue": false,
                "type": "NOT_EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "eventParametersObject",
        "displayName": "Event Parameters Object",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Provide an object with Event Parameters to merge with the parameters below. Any conflicting parameters will be overwritten with them.",
        "notSetText": "(not set)"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "eventParametersList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "SELECT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "displayValue": "Transaction ID / Event Unique ID",
                "value": "transactionId"
              },
              {
                "displayValue": "Amount",
                "value": "amount"
              },
              {
                "displayValue": "Currency",
                "value": "currency"
              },
              {
                "displayValue": "Purchased Items",
                "value": "purchasedItems"
              },
              {
                "displayValue": "Channel",
                "value": "channel"
              },
              {
                "displayValue": "Store ID",
                "value": "storeId"
              },
              {
                "displayValue": "Conversion Location Country",
                "value": "conversionLocation.country"
              },
              {
                "displayValue": "Conversion Location State",
                "value": "conversionLocation.state"
              },
              {
                "displayValue": "Conversion Location City",
                "value": "conversionLocation.city"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": []
          }
        ],
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "eventCustomParametersGroup",
    "displayName": "Event Custom Parameters",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "LABEL",
        "name": "eventCustomParametersGroupLabel",
        "displayName": "Check these help pages \u003ca href\u003d\"https://docs.api.viantinc.com/reference/onboard-onlineoffline-conversion-data\"\u003e[1]\u003c/a\u003e and \u003ca href\u003d\"https://docs.api.viantinc.com/v1.1/reference/post_v1-conversions\"\u003e[2]\u003c/a\u003e for a description of \u003ci\u003eEvent Custom Data Parameters\u003c/i\u003e.\n\u003cbr/\u003e\n\u003cb\u003eUp to 10 key-value pairs\u003c/b\u003e.\n\u003cbr/\u003e"
      },
      {
        "type": "SELECT",
        "name": "eventCustomParametersObject",
        "displayName": "Event Custom Parameters Object",
        "macrosInSelect": true,
        "selectItems": [],
        "simpleValueType": true,
        "help": "Provide an object with Event Custom Parameters to merge with the parameters below. Any conflicting parameters will be overwritten with them.",
        "notSetText": "(not set)"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "eventCustomParametersList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add Parameter"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "tagExecutionConsentSettingsGroup",
    "displayName": "Tag Execution Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given",
            "help": "Aborts the tag execution if marketing consent (\u003ci\u003ead_storage\u003c/i\u003e Google Consent Mode or Stape\u0027s Data Tag parameter) is not given."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr/\u003e\u003cbr/\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const BigQuery = require('BigQuery');
const createRegex = require('createRegex');
const generateRandom = require('generateRandom');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const Math = require('Math');
const Object = require('Object');
const Promise = require('Promise');
const sendHttpRequest = require('sendHttpRequest');
const sha256Sync = require('sha256Sync');
const templateDataStorage = require('templateDataStorage');
const toBase64 = require('toBase64');

/*==============================================================================
==============================================================================*/

const eventData = getAllEventData();
const useOptimisticScenario = isUIFieldTrue(data.useOptimisticScenario);

if (!isConsentGivenOrNotRequired(data, eventData)) {
  return data.gtmOnSuccess();
}

const url = getUrl(eventData);
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const mappedData = mapEvent(data, eventData);

sendRequest(data, mappedData);

if (useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/*==============================================================================
  Vendor related functions
==============================================================================*/

function addServerEventData(data, event) {
  if (isUIFieldTrue(data.autoMapServerEventDataParameters)) {
    event.salesData.conversionTimestamp = convertTimestampToISO(getTimestampMillis());
  }

  if (data.serverEventDataList) {
    data.serverEventDataList.forEach((d) => {
      if (d.name === 'conversionTimestamp' && makeString(d.value).match('^[0-9]+$') !== null) {
        event.salesData[d.name] = convertTimestampToISO(makeInteger(d.value));
        return;
      }
      event.salesData[d.name] = d.value;
    });
  }

  return event;
}

function getEmailAddressesFromEventData(eventData) {
  const eventDataUserData = eventData.user_data || {};

  const email =
    eventDataUserData.email ||
    eventDataUserData.email_address ||
    eventDataUserData.sha256_email ||
    eventDataUserData.sha256_email_address;

  const emailType = getType(email);

  if (emailType === 'string') return [email];
  else if (emailType === 'array') return email.length > 0 ? email : [];
  else if (emailType === 'object') {
    const emailsFromObject = Object.values(email);
    if (emailsFromObject.length) return emailsFromObject;
  }

  return [];
}

function addUserIdentifiers(data, eventData, event) {
  const itemizeUserIdentifier = (input) => {
    const type = getType(input);
    if (type === 'array') return input.filter((e) => e);
    if (type === 'string' || type === 'number') return [input];
    return [];
  };

  // Auto-mapped ones.
  const userIdentifiersListsByType = {
    email_sha256: [],
    ip: [],
    mobile_id: []
  };

  if (isUIFieldTrue(data.autoMapUserIdentifiersParameters)) {
    const emailAddresses = getEmailAddressesFromEventData(eventData);
    if (emailAddresses.length) {
      userIdentifiersListsByType.email_sha256 = emailAddresses;
      userIdentifiersListsByType.email_sha256.autoMapped = true;
    }

    if (eventData.ip_override) {
      userIdentifiersListsByType.ip.push(eventData.ip_override);
      userIdentifiersListsByType.ip.autoMapped = true;
    }

    let mobileDeviceId = eventData['x-ga-resettable_device_id'];
    const platform = eventData['x-ga-platform'];
    if (platform === 'ios' && mobileDeviceId === '00000000-0000-0000-0000-000000000000') {
      mobileDeviceId === eventData['x-ga-vendor_device_id'];
    }
    if (mobileDeviceId) {
      userIdentifiersListsByType.mobile_id.push(mobileDeviceId);
      userIdentifiersListsByType.mobile_id.autoMapped = true;
    }
  }

  if (data.userIdentifiersParametersList) {
    data.userIdentifiersParametersList.forEach((d) => {
      userIdentifiersListsByType[d.name] = userIdentifiersListsByType[d.name] || [];

      if (
        userIdentifiersListsByType[d.name].autoMapped &&
        !userIdentifiersListsByType[d.name].overridenByUI
      ) {
        userIdentifiersListsByType[d.name] = [];
        userIdentifiersListsByType[d.name].overridenByUI = true;
      }

      if (!d.value) return;

      const itemizedUserIdentifier = itemizeUserIdentifier(d.value);

      if (getType(itemizedUserIdentifier) === 'array' && itemizedUserIdentifier.length) {
        itemizedUserIdentifier.forEach((item) => {
          userIdentifiersListsByType[d.name].push(item);
        });
      }
    });
  }

  const userIdentifiers = [];
  Object.keys(userIdentifiersListsByType).forEach((type) => {
    const userIdentifiersListByType = userIdentifiersListsByType[type];
    if (getType(userIdentifiersListByType) === 'array') {
      userIdentifiersListByType.forEach((userIdentifier) => {
        userIdentifiers.push({ type: type, value: userIdentifier });
      });
    }
  });

  event.salesData.identifiers = userIdentifiers;

  return event;
}

function getEventId(eventData) {
  return (
    eventData.transaction_id ||
    eventData.eventId ||
    eventData.event_id ||
    eventData.unique_event_id ||
    getTimestampMillis() + '_' + generateRandom(100000000, 999999999)
  );
}

function addEventData(data, eventData, event) {
  if (isUIFieldTrue(data.autoMapServerEventDataParameters)) {
    let currencyFromItems;
    let valueFromItems;
    if (getType(eventData.items) === 'array' && eventData.items.length) {
      event.salesData.purchasedItems = [];
      valueFromItems = 0;
      currencyFromItems = eventData.items[0].currency;
      const itemIdKey = data.itemIdKey ? data.itemIdKey : 'item_id';
      eventData.items.forEach((i) => {
        const item = {};
        if (i[itemIdKey]) item.itemId = makeString(i[itemIdKey]);
        if (i.item_name) item.productName = makeString(i.item_name);
        if (i.quantity) item.quantity = makeInteger(i.quantity);
        if (i.item_category) item.productCategory = makeString(i.item_category);
        if (isValidValue(i.price)) {
          item.price = makeNumber(i.price);
          valueFromItems += item.quantity ? item.quantity * item.price : item.price;
        }
        event.salesData.purchasedItems.push(item);
      });
    }

    if (isValidValue(eventData.value)) {
      const value = makeNumber(eventData.value);
      event.salesData.amount = value;
    } else if (isValidValue(valueFromItems)) {
      event.salesData.amount = valueFromItems;
    }

    const currency = eventData.currency || currencyFromItems;
    if (currency) event.salesData.currency = makeString(currency);

    const eventId = data.transactionId || getEventId(eventData);
    if (eventId) {
      event.salesData.transactionId = makeString(eventId);
    }
  }

  if (getType(data.eventParametersObject) === 'object') {
    mergeObj(event.salesData, data.eventParametersObject);
  }
  if (data.eventParametersList) {
    data.eventParametersList.forEach((d) => {
      const names = d.name.split('.');
      names.reduce((acc, name, index) => {
        const isLastKey = index === names.length - 1;
        if (isLastKey) acc[name] = d.value;
        else acc[name] = acc[name] || {};
        return acc[name];
      }, event.salesData);
    });
  }

  return event;
}

function addEventCustomData(data, event) {
  const customParameters = {};

  if (getType(data.eventCustomParametersObject) === 'object') {
    mergeObj(customParameters, data.eventCustomParametersObject);
  }

  if (data.eventCustomParametersList) {
    data.eventCustomParametersList.forEach((d) => {
      customParameters[d.name] = d.value;
    });
  }

  event.salesData.custom = customParameters;

  return event;
}

function normalizePhoneNumber(phoneNumber) {
  if (!phoneNumber) return phoneNumber;

  const nonDigitsRegex = createRegex('[^0-9]', 'g');
  phoneNumber = makeString(phoneNumber).replace(nonDigitsRegex, '');
  return phoneNumber;
}

function hashDataIfNeeded(event) {
  const userIdentifiers = event.salesData.identifiers;
  const hasUserIdentifiers = getType(userIdentifiers) === 'array' && userIdentifiers.length;

  if (hasUserIdentifiers) {
    const userIdentifiersKeysToHash = {
      email_sha256: true,
      phonenumber_sha256: true,
      address_sha256: true
    };
    const userIdentifiersKeysToNormalize = {
      phonenumber_sha256: normalizePhoneNumber
    };
    userIdentifiers.forEach((userIdentifier) => {
      const type = userIdentifier.type;
      let value = userIdentifier.value;
      if (!userIdentifiersKeysToHash[type]) return;
      if (userIdentifiersKeysToNormalize[type]) value = userIdentifiersKeysToNormalize[type](value);
      userIdentifier.value = hashData(value);
    });
  }

  return event;
}

function mapEventName(data, eventData) {
  if (data.eventTypeSetupMethod === 'inherit') {
    const eventName = eventData.event_name;

    const gaToEventName = {
      page_view: 'PageView',
      view_item: 'ItemView',
      add_to_cart: 'AddToCart',
      begin_checkout: 'InitiateCheckout',
      add_payment_info: 'AddPaymentInfo',
      generate_lead: 'Lead',
      purchase: 'Purchase'
    };

    return gaToEventName[eventName] || eventName;
  }

  return data.eventType === 'standard' ? data.eventNameStandard : data.eventNameCustom;
}

function mapEvent(data, eventData) {
  const event = {
    accountId: makeInteger(data.accountId),
    advertisers: data.advertiserIds.filter((obj) => !!obj).map((obj) => makeInteger(obj.id)),
    salesData: {
      conversionEventType: mapEventName(data, eventData)
    }
  };
  const mappedData = [event];

  addServerEventData(data, event);
  addUserIdentifiers(data, eventData, event);
  addEventData(data, eventData, event);
  addEventCustomData(data, event);
  hashDataIfNeeded(event);

  return mappedData;
}

function generateRequestBaseUrlByRequestType(requestType) {
  const version = '1';
  const requestPathByRequestType = {
    accessToken: '/oauth2/authenticate',
    conversion: '/conversions'
  };
  return 'https://vdp-connect-api.viantinc.com/v' + version + requestPathByRequestType[requestType];
}

function generateRequestOptionsByRequestType(data, requestType, accessToken) {
  const requestOptionsByRequestType = {
    accessToken: {
      method: 'POST',
      headers: {
        Authorization: 'Basic ' + toBase64(data.authUsername + ':' + data.authPassword),
        'Content-Type': 'application/json'
      }
    },
    conversion: {
      method: 'POST',
      headers: {
        Authorization: 'Bearer ' + accessToken,
        'Content-Type': 'application/json'
      }
    }
  };

  return requestOptionsByRequestType[requestType];
}

function getAccessToken(data, byPassTokenCacheCheck) {
  const cacheKey = sha256Sync('viantcapi' + data.authUsername + data.authPassword);
  const auth = templateDataStorage.getItemCopy(cacheKey);

  if (!byPassTokenCacheCheck && getType(auth) === 'object') {
    const accessToken = auth.accessToken;
    const expiresAt = auth.expiresAt; // TTL in milliseconds.
    const isAccessTokenValid = getTimestampMillis() < expiresAt;
    if (accessToken && isAccessTokenValid) {
      return Promise.create((resolve) => resolve(accessToken));
    }
  }

  const requestUrl = generateRequestBaseUrlByRequestType('accessToken');
  const requestOptions = generateRequestOptionsByRequestType(data, 'accessToken');

  log({
    Name: 'ViantCAPI',
    Type: 'Request',
    EventName: 'AccessToken',
    RequestMethod: requestOptions.method,
    RequestUrl: requestUrl
  });

  return sendHttpRequest(requestUrl, requestOptions)
    .then((result) => {
      log({
        Name: 'ViantCAPI',
        Type: 'Response',
        EventName: 'AccessToken',
        ResponseStatusCode: result.statusCode,
        ResponseHeaders: result.headers
      });

      if (result.statusCode === 200) {
        const parsedBody = JSON.parse(result.body || '{}');
        if (!parsedBody.access_token || !parsedBody.expires_in) {
          return !useOptimisticScenario ? data.gtmOnFailure() : undefined;
        }

        const auth = {
          accessToken: parsedBody.access_token,
          // 90% of the real expiration time.
          expiresAt: getTimestampMillis() + parsedBody.expires_in * 1000 * 0.9
        };
        templateDataStorage.setItemCopy(cacheKey, auth);
        return auth.accessToken;
      } else {
        return !useOptimisticScenario ? data.gtmOnFailure() : undefined;
      }
    })
    .catch((result) => {
      log({
        Name: 'ViantCAPI',
        Type: 'Message',
        EventName: 'AccessToken',
        Message: 'Request failed or timed out.',
        Reason: JSON.stringify(result)
      });

      return !useOptimisticScenario ? data.gtmOnFailure() : undefined;
    });
}

function sendConversion(data, mappedData, accessToken) {
  const requestUrl = generateRequestBaseUrlByRequestType('conversion');
  const requestOptions = generateRequestOptionsByRequestType(data, 'conversion', accessToken);

  const eventName = mappedData[0].salesData.conversionEventType;
  log({
    Name: 'ViantCAPI',
    Type: 'Request',
    EventName: eventName,
    RequestMethod: requestOptions.method,
    RequestUrl: requestUrl,
    RequestBody: mappedData
  });

  return sendHttpRequest(requestUrl, requestOptions, JSON.stringify(mappedData))
    .then((result) => {
      log({
        Name: 'ViantCAPI',
        Type: 'Response',
        EventName: eventName,
        ResponseStatusCode: result.statusCode,
        ResponseHeaders: result.headers,
        ResponseBody: result.body
      });

      const parsedBody = JSON.parse(result.body || '{}');

      if (result.statusCode >= 200 && result.statusCode < 400) {
        return !useOptimisticScenario ? data.gtmOnSuccess() : undefined;
      } else if (result.statusCode === 401 && parsedBody.message === 'Jwt is expired') {
        return sendRequest(data, mappedData, true);
      } else {
        return !useOptimisticScenario ? data.gtmOnFailure() : undefined;
      }
    })
    .catch((result) => {
      log({
        Name: 'ViantCAPI',
        Type: 'Message',
        EventName: eventName,
        Message: 'Request failed or timed out.',
        Reason: JSON.stringify(result)
      });

      return !useOptimisticScenario ? data.gtmOnFailure() : undefined;
    });
}

function sendRequest(data, mappedData, byPassTokenCacheCheck) {
  getAccessToken(data, byPassTokenCacheCheck).then((accessToken) => {
    if (!accessToken) return;
    sendConversion(data, mappedData, accessToken);
  });
}

/*==============================================================================
  Helpers
==============================================================================*/

function getUrl(eventData) {
  return eventData.page_location || eventData.page_referrer || getRequestHeader('referer');
}

function mergeObj(target, source) {
  for (const key in source) {
    if (source.hasOwnProperty(key)) target[key] = source[key];
  }
  return target;
}

function isUIFieldTrue(field) {
  return [true, 'true'].indexOf(field) !== -1;
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function isHashed(value) {
  if (!value) return false;
  return makeString(value).match('^[A-Fa-f0-9]{64}$') !== null;
}

function hashData(value) {
  if (!value) return value;

  const type = getType(value);

  if (value === 'undefined' || value === 'null') return undefined;

  if (type === 'array') {
    return value.map((val) => hashData(val));
  }

  if (type === 'object') {
    return Object.keys(value).reduce((acc, val) => {
      acc[val] = hashData(value[val]);
      return acc;
    }, {});
  }

  if (isHashed(value)) return value;

  return sha256Sync(makeString(value).trim().toLowerCase(), {
    outputEncoding: 'hex'
  });
}

function convertTimestampToISO(timestamp) {
  const leapYear = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  const nonLeapYear = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
  const secToMs = (s) => s * 1000;
  const minToMs = (m) => m * secToMs(60);
  const hoursToMs = (h) => h * minToMs(60);
  const daysToMs = (d) => d * hoursToMs(24);
  const padStart = (value, length) => {
    let result = makeString(value);
    while (result.length < length) {
      result = '0' + result;
    }
    return result;
  };

  const fourYearsInMs = daysToMs(365 * 4 + 1);
  let year = 1970 + Math.floor(timestamp / fourYearsInMs) * 4;
  timestamp = timestamp % fourYearsInMs;

  while (true) {
    let isLeapYear = year % 4 === 0;
    let nextTimestamp = timestamp - daysToMs(isLeapYear ? 366 : 365);
    if (nextTimestamp < 0) {
      break;
    }
    timestamp = nextTimestamp;
    year = year + 1;
  }

  const daysByMonth = year % 4 === 0 ? leapYear : nonLeapYear;

  let month = 0;
  for (let i = 0; i < daysByMonth.length; i++) {
    const msInThisMonth = daysToMs(daysByMonth[i]);
    if (timestamp > msInThisMonth) {
      timestamp = timestamp - msInThisMonth;
    } else {
      month = i + 1;
      break;
    }
  }

  const date = Math.ceil(timestamp / daysToMs(1));
  timestamp = timestamp - daysToMs(date - 1);
  const hours = Math.floor(timestamp / hoursToMs(1));
  timestamp = timestamp - hoursToMs(hours);
  const minutes = Math.floor(timestamp / minToMs(1));
  timestamp = timestamp - minToMs(minutes);
  const sec = Math.floor(timestamp / secToMs(1));
  timestamp = timestamp - secToMs(sec);
  const milliSeconds = timestamp;

  return (
    year +
    '-' +
    padStart(month, 2) +
    '-' +
    padStart(date, 2) +
    'T' +
    padStart(hours, 2) +
    ':' +
    padStart(minutes, 2) +
    ':' +
    padStart(sec, 2) +
    '.' +
    padStart(milliSeconds, 3) +
    'Z'
  );
}

function isConsentGivenOrNotRequired(data, eventData) {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  rawDataToLog.TraceId = getRequestHeader('trace-id');

  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;

    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key;
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  dataToLog.timestamp = getTimestampMillis();

  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  BigQuery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://vdp-connect-api.viantinc.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_template_storage",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Tag is not executed when Tag Execution Consent is Denied
  code: |-
    setGetAllEventData({
      'x-ga-gcs': 'G100'
    });
    setAllMockData({
      adStorageConsent: 'required'
    });

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
    assertApi('sendHttpRequest').wasNotCalled();
- name: '[Request] [Auth] URL and Options are successfully built and sent'
  code: "setAllMockData();\n\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  const response = { statusCode: 200 };\n  \n  if (requestUrl\
    \ === EXPECTED_ACCESS_TOKEN_ENDPOINT) {\n    response.body = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);\
    \  \n  }\n  \n  return Promise.create((resolve, reject) => {\n    resolve(response);\n\
    \  });\n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('sendHttpRequest').wasCalledWith(EXPECTED_ACCESS_TOKEN_ENDPOINT,\
    \ {\n    method: 'POST',\n    headers: {\n      Authorization: 'Basic ' + toBase64(mockData.authUsername\
    \ + ':' + mockData.authPassword),\n      'Content-Type': 'application/json'\n\
    \    }\n  });\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Request] [Auth] Token does not exist in cache, request must be made and
    cache should be updated'
  code: "setAllMockData();\n\nmockObject('templateDataStorage', {\n  getItemCopy:\
    \ (key) => { \n    assertThat(key).isEqualTo(EXPECTED_CACHE_KEY);\n    return;\n\
    \  },\n  setItemCopy: (key, value) => {\n    assertThat(key).isEqualTo(EXPECTED_CACHE_KEY);\n\
    \    assertThat(value).isEqualTo(EXPECTED_CACHE_TOKEN_OBJ);\n  }\n});\n\nlet tokenRequestWasMade\
    \ = false;\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody)\
    \ => {\n  const response = { statusCode: 200 };\n  \n  if (requestUrl === EXPECTED_ACCESS_TOKEN_ENDPOINT)\
    \ {\n    tokenRequestWasMade = true;\n    response.body = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);\
    \  \n  }\n  \n  return Promise.create((resolve, reject) => {\n    resolve(response);\n\
    \  });\n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertThat(tokenRequestWasMade,\
    \ 'Token request should have been made.').isTrue();\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Request] [Auth] Token exists in cache but is invalid, request must be made
    and cache should be updated'
  code: "setAllMockData();\n\nmockObject('templateDataStorage', {\n  getItemCopy:\
    \ (key) => { \n    assertThat(key).isEqualTo(EXPECTED_CACHE_KEY);\n    return\
    \ {\n      accessToken: EXPECTED_CACHE_TOKEN_OBJ.accessToken,\n      expiresAt:\
    \ 1\n    };\n  },\n  setItemCopy: (key, value) => {\n    assertThat(key).isEqualTo(EXPECTED_CACHE_KEY);\n\
    \    assertThat(value).isEqualTo(EXPECTED_CACHE_TOKEN_OBJ);\n  }\n});\n\n\nlet\
    \ tokenRequestWasMade = false;\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  const response = { statusCode: 200 };\n  \n  if (requestUrl\
    \ === EXPECTED_ACCESS_TOKEN_ENDPOINT) {\n    tokenRequestWasMade = true;\n   \
    \ response.body = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);  \n  }\n  \n  return\
    \ Promise.create((resolve, reject) => {\n    resolve(response);\n  });\n});\n\n\
    runCode(mockData);\n\ncallLater(() => {\n  assertThat(tokenRequestWasMade, 'Token\
    \ request should have been made.').isTrue();\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Request] [Auth] Token in cache is valid, request must not be made and cache
    should not be updated'
  code: "setAllMockData();\n\nlet templateDataStorageSetItemCopyWasCalled = false;\n\
    mockObject('templateDataStorage', {\n  getItemCopy: (key) => { \n    assertThat(key).isEqualTo(EXPECTED_CACHE_KEY);\n\
    \    return {\n      accessToken: EXPECTED_CACHE_TOKEN_OBJ.accessToken,\n    \
    \  expiresAt: EXPECTED_CACHE_TOKEN_OBJ.expiresAt + 10\n    };\n  },\n  setItemCopy:\
    \ (key, value) => {\n    if (key === EXPECTED_CACHE_KEY) templateDataStorageSetItemCopyWasCalled\
    \ = true;\n  }\n});\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody)\
    \ => {\n  const response = { statusCode: 200 };\n  \n  if (requestUrl === EXPECTED_ACCESS_TOKEN_ENDPOINT)\
    \ {\n    fail('Token request should not have been made. Should use cached value\
    \ instead.');\n    response.body = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);\
    \  \n  }\n  \n  return Promise.create((resolve, reject) => {\n    resolve(response);\n\
    \  });\n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertThat(templateDataStorageSetItemCopyWasCalled,\
    \ 'Access token in cache should not have been updated.').isFalse();\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Request] [Auth] Failure handler should be called if token is not successfully
    retrieved, cache should not be updated and conversion should not be sent'
  code: "setAllMockData();\n\n[\n  { \n    description: 'Status === 200 and access_token\
    \ key is not in response',\n    mock: () => {\n      const response = { statusCode:\
    \ 200, body: JSON.stringify({}) };\n      return Promise.create((resolve, reject)\
    \ => {\n        resolve(response);\n      });\n    }\n  },\n  { \n    description:\
    \ 'Status !== 200',\n    mock: () => {\n      const response = { statusCode: 500\
    \ };\n      return Promise.create((resolve, reject) => {\n        resolve(response);\n\
    \      });\n    }\n  },\n  { \n    description: '.catch',\n    mock: () => {\n\
    \      return Promise.create((resolve, reject) => {\n        reject({ reason:\
    \ 'Failed'});        \n      });\n    }\n  }\n].forEach(scenario => {\n  let templateDataStorageSetItemCopyWasCalled\
    \ = false;\n  mockObject('templateDataStorage', {\n    getItemCopy: (key) => {\
    \ \n      return;\n    },\n    setItemCopy: (key, value) => {\n      if (key ===\
    \ EXPECTED_CACHE_KEY) templateDataStorageSetItemCopyWasCalled = true;\n    }\n\
    \  });\n  \n  mock('sendHttpRequest', (requestUrl, requestOptions, requestBody)\
    \ => {        \n    if (requestUrl === EXPECTED_CONVERSIONS_ENDPOINT) {\n    \
    \  fail('Conversion requested should not have been sent');\n    }\n    \n    return\
    \ scenario.mock();\n  });\n  \n  runCode(mockData);\n  \n  callLater(() => {\n\
    \    assertThat(templateDataStorageSetItemCopyWasCalled, 'Access token in cache\
    \ should not have been updated.').isFalse();\n    assertApi('gtmOnSuccess').wasNotCalled();\n\
    \    assertApi('gtmOnFailure').wasCalled();\n  });\n});"
- name: '[Request] [Conversion] URL and Options are successfully built and sent'
  code: "setAllMockData();\n\nlet conversionRequestWasMade = false;\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const response = { statusCode:\
    \ 200 };\n    \n  if (requestUrl === EXPECTED_ACCESS_TOKEN_ENDPOINT) {\n    response.body\
    \ = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);  \n  } else if (requestUrl ===\
    \ EXPECTED_CONVERSIONS_ENDPOINT) {\n    assertThat(requestUrl).isEqualTo(EXPECTED_CONVERSIONS_ENDPOINT);\
    \ // Redundant\n    assertThat(requestOptions).isEqualTo({\n      method: 'POST',\n\
    \      headers: {\n        Authorization: 'Bearer ' + EXPECTED_ACCESS_TOKEN,\n\
    \        'Content-Type': 'application/json'\n      }\n    });\n    conversionRequestWasMade\
    \ = true;\n  }\n  \n  return Promise.create((resolve, reject) => {\n    resolve(response);\n\
    \  });\n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertThat(conversionRequestWasMade,\
    \ 'Conversion request should have been made.').isTrue();\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Request] [Conversion] [Data from auto-mapping] Is successfully built and
    sent'
  code: "setAllMockData({\n  autoMapServerEventDataParameters: true,\n  serverEventDataList:\
    \ undefined,\n  autoMapEventParameters: true,\n  eventParametersObject: undefined,\n\
    \  eventParametersList: undefined,\n  autoMapUserIdentifiersParameters: true,\n\
    \  userIdentifiersParametersList: undefined,\n  eventCustomParametersObject: undefined,\n\
    \  eventCustomParametersList: undefined\n});\n\nsetGetAllEventData();\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const response = { statusCode:\
    \ 200 };\n    \n  if (requestUrl === EXPECTED_ACCESS_TOKEN_ENDPOINT) {\n    response.body\
    \ = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);  \n  } else if (requestUrl ===\
    \ EXPECTED_CONVERSIONS_ENDPOINT) {\n    const parsedBody = JSON.parse(requestBody);\n\
    \    assertThat(parsedBody).isEqualTo([\n      {\n        accountId: 2222,\n \
    \       advertisers: [69756, 111111],\n        salesData: {\n          conversionEventType:\
    \ 'PageView',\n          conversionTimestamp: '2025-05-22T20:30:30.456Z',\n  \
    \        identifiers: [\n            {\n              type: 'email_sha256',\n\
    \              value:\n                '27c6b8e780cfc293ef0436f7d8421af0bed83caae706734b49f8e95d5295b462'\n\
    \            },\n            {\n              type: 'email_sha256',\n        \
    \      value:\n                'fea4050abbde8296abcf9b3a4ada06167e9299081c9273573a53ac5c20b6578f'\n\
    \            },\n            { type: 'ip', value: '2804:14d:c096:8dd6:311c:8c00:e6c:e33'\
    \ },\n            { type: 'mobile_id', value: 'x-ga-resettable_device_id' }\n\
    \          ],\n          purchasedItems: [\n            {\n              itemId:\
    \ 'SKU_12345',\n              productName: 'Stan and Friends Tee',\n         \
    \     quantity: 3,\n              productCategory: 'Apparel|iajsdiajsd|oasodiasd',\n\
    \              price: 10.01\n            },\n            {\n              itemId:\
    \ 'SKU_12346',\n              productName: \"Google Grey Women's (Tee)\",\n  \
    \            quantity: 2,\n              productCategory: 'Apparel|iajsdiajsd|oasodiasd',\n\
    \              price: 21.01\n            }\n          ],\n          amount: 123.45,\n\
    \          currency: 'BRL',\n          transactionId: 'transaction_id',\n    \
    \      custom: {}\n        }\n      }\n    ]);\n  }\n  \n  return Promise.create((resolve,\
    \ reject) => {\n    resolve(response);\n  });\n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Request] [Conversion] [Data from UI fields] Is successfully built and sent'
  code: "setAllMockData({\n  autoMapServerEventDataParameters: false,\n  autoMapUserIdentifiersParameters:\
    \ false,\n  autoMapEventParameters: false\n});\n\nsetGetAllEventData();\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const response = { statusCode:\
    \ 200 };\n    \n  if (requestUrl === EXPECTED_ACCESS_TOKEN_ENDPOINT) {\n    response.body\
    \ = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);  \n  } else if (requestUrl ===\
    \ EXPECTED_CONVERSIONS_ENDPOINT) {\n    const parsedBody = JSON.parse(requestBody);\n\
    \    assertThat(parsedBody).isEqualTo([\n      {\n        accountId: 2222,\n \
    \       advertisers: [69756, 111111],\n        salesData: {\n          conversionEventType:\
    \ 'PageView',\n          conversionTimestamp: '2025-10-10T14:11:21.000Z',\n  \
    \        identifiers: [\n            {\n              type: 'email_sha256',\n\
    \              value:\n                '9b431636bd164765d63c573c346708846af4f68fe3701a77a3bdd7e7e5166254'\n\
    \            },\n            {\n              type: 'email_sha256',\n        \
    \      value:\n                'fea4050abbde8296abcf9b3a4ada06167e9299081c9273573a53ac5c20b6578f'\n\
    \            },\n            { type: 'ip', value: '192.168.0.1' },\n         \
    \   { type: 'mobile_id', value: 'mobileId1' },\n            { type: 'mobile_id',\
    \ value: 'mobileId2' },\n            {\n              type: 'phonenumber_sha256',\n\
    \              value:\n                'b401223f253fc05ba61db2d663aa8b1142e427ddbfb5f29b8d2474c37bb19d2c'\n\
    \            },\n            {\n              type: 'address_sha256',\n      \
    \        value:\n                '9b37245a37d6b19673dbe98a4703911a548e1294b61304c6738124f7b62a0502'\n\
    \            }\n          ],\n          channel: 'test',\n          amount: '123',\n\
    \          currency: 'BRL',\n          purchasedItems: [\n            {\n    \
    \          itemId: 'SKU_12345',\n              productName: 'Stan and Friends\
    \ Tee',\n              productCategory: 'Apparel|iajsdiajsd|oasodiasd',\n    \
    \          price: 10.01,\n              quantity: 3\n            },\n        \
    \    {\n              itemId: 'SKU_12346',\n              productName: \"Google\
    \ Grey Women's (Tee)\",\n              productCategory: 'Apparel|iajsdiajsd|oasodiasd',\n\
    \              price: 21.01,\n              quantity: 2\n            }\n     \
    \     ],\n          storeId: 'storeId',\n          conversionLocation: {\n   \
    \         country: 'clCountry',\n            state: 'clState',\n            city:\
    \ 'clCity'\n          },\n          transactionId: 'eventId',\n          custom:\
    \ { foo: 'test', abc: '123' }\n        }\n      }\n    ]);\n  }\n  \n  return\
    \ Promise.create((resolve, reject) => {\n    resolve(response);\n  });\n});\n\n\
    runCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Request] [Conversion] Token must be renewed if API returns 401 and a expired
    token message'
  code: "setAllMockData();\n\n// Cached token that is valid according to the stored\
    \ expiredAt, but the Conversions API endpoint will return that it's expired.\n\
    mockObject('templateDataStorage', {\n  getItemCopy: (key) => { \n    assertThat(key).isEqualTo(EXPECTED_CACHE_KEY);\n\
    \    return {\n      accessToken: EXPECTED_CACHE_TOKEN_OBJ.accessToken,\n    \
    \  expiresAt: EXPECTED_CACHE_TOKEN_OBJ.expiresAt + 10\n    };\n  },\n  setItemCopy:\
    \ (key, value) => { }\n});\n\nlet conversionRequestsCount = 0;\nlet tokenRequestsCount\
    \ = 0;\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  if (requestUrl === EXPECTED_ACCESS_TOKEN_ENDPOINT) {\n    ++tokenRequestsCount;\n\
    \    const response = { statusCode: 200 };\n    response.body = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);\
    \  \n    return Promise.create((resolve, reject) => {\n      resolve(response);\
    \        \n    });\n  } else if (requestUrl === EXPECTED_CONVERSIONS_ENDPOINT)\
    \ {\n    ++conversionRequestsCount;\n    const response = conversionRequestsCount\
    \ === 1 ? { statusCode: 401, body: JSON.stringify({ message: 'Jwt is expired'\
    \ }) } : { statusCode: 200 };\n    return Promise.create((resolve, reject) =>\
    \ {\n      resolve(response);\n    });\n  }\n\n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertThat(tokenRequestsCount, 'Access token request should have been\
    \ made only 1 time.').isEqualTo(1);\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Request] [Conversion] Failure handler should be called'
  code: "setAllMockData();\n\n[\n  { \n    description: 'Status === 500',\n    mock:\
    \ () => {\n      const response = { statusCode: 500 };\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve(response);\n      });\n    }\n  },\n  { \n   \
    \ description: 'Status === 401, and not \"Jwt is expired\"',\n    mock: () =>\
    \ {\n      const response = { statusCode: 401 };\n      return Promise.create((resolve,\
    \ reject) => {\n        resolve(response);\n      });\n    }\n  },\n  { \n   \
    \ description: '.catch',\n    mock: () => {\n      return Promise.create((resolve,\
    \ reject) => {\n        reject({ reason: 'Failed'});        \n      });\n    }\n\
    \  }\n].forEach(scenario => {\n  setAllMockData();\n  \n  mock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n    if (requestUrl === EXPECTED_ACCESS_TOKEN_ENDPOINT)\
    \ {\n      const response = { statusCode: 200 };\n      response.body = JSON.stringify(EXPECTED_RESPONSE_TOKEN_OBJ);\
    \  \n      return Promise.create((resolve, reject) => {\n        resolve(response);\
    \        \n      });\n    } else if (requestUrl === EXPECTED_CONVERSIONS_ENDPOINT)\
    \ {\n      return scenario.mock();\n    }\n  \n  });\n  \n  runCode(mockData);\n\
    \  \n  callLater(() => {\n    assertApi('gtmOnSuccess').wasNotCalled();\n    assertApi('gtmOnFailure').wasCalled();\n\
    \  });\n});"
- name: '[Logs] Should log to console'
  code: "const originalMockData = setAllMockData();\n\n[\n  // if the 'Always log\
    \ to console' option is selected\n  { mockData: { logType: 'always' }, expectedDebugMode:\
    \ true },\n  // if the 'Log during debug and preview' option is selected AND is\
    \ on preview mode\n  { mockData: { logType: 'debug' }, expectedDebugMode: true\
    \ },\n].forEach(scenario => {\n  const copyMockData = JSON.parse(JSON.stringify(originalMockData));\n\
    \  mergeObj(copyMockData, scenario.mockData);\n  \n  mock('getContainerVersion',\
    \ () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n    };\n\
    \  }); \n  \n  mock('logToConsole', (logData) => {\n    const parsedLogData =\
    \ JSON.parse(logData);\n    requiredConsoleKeys.forEach(p => assertThat(parsedLogData[p]).isDefined());\n\
    \  });\n  \n  runCode(copyMockData);\n  \n  callLater(() => {\n    assertApi('logToConsole').wasCalled();\n\
    \  });\n});"
- name: '[Logs] Should NOT log to console'
  code: "const originalMockData = setAllMockData();\nmockData.logType = 'debug';\n\
    \n[\n  // if the 'Log during debug and preview' option is selected AND is NOT\
    \ on preview mode\n  { mockData: { logType: 'debug' }, expectedDebugMode: false\
    \ },\n  // if the 'Do not log' option is selected\n  { mockData: { logType: 'no'\
    \ }, expectedDebugMode: undefined },\n].forEach(scenario => {\n  const copyMockData\
    \ = JSON.parse(JSON.stringify(originalMockData));\n  mergeObj(copyMockData, scenario.mockData);\n\
    \  \n  mock('getContainerVersion', () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n\
    \    };\n  });\n  \n  runCode(copyMockData);\n\n  callLater(() => {\n    assertApi('logToConsole').wasNotCalled();\n\
    \  });\n});"
- name: '[Logs] Should NOT log to BQ, if the ''Do not log to BigQuery'' option is
    selected'
  code: "setAllMockData();\nmockData.bigQueryLogType = 'no';\n\n// assertApi doesn't\
    \ work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mockObject('BigQuery', {\n  insert: (connectionInfo, rows, options) => { \n  \
    \  fail('BigQuery.insert should not have been called.');\n    return Promise.create((resolve,\
    \ reject) => {\n      resolve();\n    });\n  }\n});\n\nrunCode(mockData);"
- name: '[Logs] Should log to BQ, if the ''Log to BigQuery'' option is selected'
  code: "setAllMockData();\nmockData.bigQueryLogType = 'always';\n\n// assertApi doesn't\
    \ work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mockObject('BigQuery', {\n  insert: (connectionInfo, rows, options) => { \n  \
    \  assertThat(connectionInfo).isDefined();\n    assertThat(rows).isArray();\n\
    \    assertThat(rows).hasLength(1);\n    requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \    assertThat(options).isEqualTo(expectedBqOptions);\n    return Promise.create((resolve,\
    \ reject) => {\n      resolve();\n    });\n  }\n});\n\nrunCode(mockData);"
setup: "const JSON = require('JSON');\nconst Promise = require('Promise');\nconst\
  \ parseUrl = require('parseUrl');\nconst Object = require('Object');\nconst makeInteger\
  \ = require('makeInteger');\nconst toBase64 = require('toBase64');\nconst sha256Sync\
  \ = require('sha256Sync');\nconst callLater = require('callLater');\n\nfunction\
  \ mergeObj(target, source) {\n  for (const key in source) {\n    if (source.hasOwnProperty(key))\
  \ target[key] = source[key];\n  }\n  return target;\n}\n\nconst setGetAllEventData\
  \ = (objToBeMerged) => {\n  mock('getAllEventData', mergeObj({\n    'x-ga-protocol_version':\
  \ '2',\n    'x-ga-measurement_id': 'G-123ABC',\n    'x-ga-gtm_version': '45je55e1za200',\n\
  \    'x-ga-page_id': 1747422523211,\n    'x-ga-gcd': '13l3l3l3l1l1',\n    'x-ga-npa':\
  \ '0',\n    'x-ga-dma': '0',\n    'x-ga-mp2-tag_exp':\n      '101509157~103116025~103130498~103130500~103136993~103136995~103200001~103207802~103211513~103233427~103252644~103252646~103263073~103301114~103301116',\n\
  \    client_id: 'AUJctU7H7hBB/aMuhE4pKwGu5DWDdklg5abyyyn8i/I=.1747154479',\n   \
  \ 'x-ga-ecid': '1294673677',\n    language: 'en-us',\n    screen_resolution: '1512x982',\n\
  \    event_location: { country: 'BR', region: 'SP' },\n    event_id: '101509157~103116025~103130498',\n\
  \    timestamp: 1748377016,\n    client_hints: {\n      architecture: 'arm',\n \
  \     bitness: '64',\n      full_version_list: [\n        { brand: 'Chromium', version:\
  \ '136.0.7103.93' },\n        { brand: 'Google Chrome', version: '136.0.7103.93'\
  \ },\n        { brand: 'Not.A/Brand', version: '99.0.0.0' }\n      ],\n      mobile:\
  \ false,\n      model: '',\n      platform: 'macOS',\n      platform_version: '15.2.0',\n\
  \      wow64: false,\n      brands: [\n        { brand: 'Chromium', version: '136'\
  \ },\n        { brand: 'Google Chrome', version: '136' },\n        { brand: 'Not.A/Brand',\
  \ version: '99' }\n      ]\n    },\n    'x-ga-are': '1',\n    'x-ga-mp2-frm': '0',\n\
  \    'x-ga-pscdl': 'noapi',\n    'x-ga-system_properties': { eu: [34], tu: 'BA',\
  \ ss: '1', ee: true },\n    'x-sst-system_properties': {\n      etld: 'google.com.br',\n\
  \      tft: '1747422523211',\n      lpc: '60493049',\n      navt: 'r',\n      ude:\
  \ '0',\n      sw_exp: '1',\n      request_start_time_ms: 1747422524851\n    },\n\
  \    'x-ga-request_count': 1,\n    'x-ga-platform': 'ios',\n    'x-ga-resettable_device_id':\
  \ 'x-ga-resettable_device_id',\n    ga_session_id: '1747422523',\n    ga_session_number:\
  \ 3,\n    'x-ga-mp2-seg': '0',\n    page_location: 'https://example.com/?test=1i23i21j3',\n\
  \    page_title: 'Example Domain',\n    event_name: 'page_view',\n    'x-ga-tfd':\
  \ 5784,\n    ip_override: '2804:14d:c096:8dd6:311c:8c00:e6c:e33',\n    user_agent:\n\
  \      'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML,\
  \ like Gecko) Chrome/136.0.0.0 Safari/537.36',\n    value: 123.45,\n    currency:\
  \ 'BRL',\n    user_id: 'userId',\n    user_data: {\n      email: { 0: 'userEmail',\
  \ 1: 'test2@example.net' },\n      phone_number: '+55 (19) 99999-9999'\n    },\n\
  \    coupon: 'coupon',\n    transaction_id: 'transaction_id',\n    search_term:\
  \ 'search_term',\n    items: [\n      {\n        item_id: 'SKU_12345',\n       \
  \ item_name: 'Stan and Friends Tee',\n        affiliation: 'Google Merchandise Store',\n\
  \        coupon: 'SUMMER_FUN',\n        discount: 2.22,\n        index: 0,\n   \
  \     item_brand: 'Google',\n        item_category: 'Apparel|iajsdiajsd|oasodiasd',\n\
  \        item_list_id: 'related_products',\n        item_list_name: 'Related Products',\n\
  \        item_variant: 'green',\n        location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n\
  \        price: 10.01,\n        quantity: 3,\n        item_group_id: 'abc'\n   \
  \   },\n      {\n        item_id: 'SKU_12346',\n        item_name: \"Google Grey\
  \ Women's (Tee)\",\n        affiliation: 'Google Merchandise Store',\n        coupon:\
  \ 'SUMMER_FUN',\n        discount: 3.33,\n        index: 1,\n        item_brand:\
  \ 'Google',\n        item_category: 'Apparel|iajsdiajsd|oasodiasd',\n        item_list_id:\
  \ 'related_products',\n        item_list_name: 'Related Products',\n        item_variant:\
  \ 'gray',\n        location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n        price: 21.01,\n\
  \        promotion_id: 'P_12345',\n        promotion_name: 'Summer Sale',\n    \
  \    quantity: 2,\n        item_group_id: 'xyz'\n      }\n    ]\n  }, objToBeMerged\
  \ || {}));\n};\n\nconst expectedBigQuerySettings = {\n  logBigQueryProjectId: 'logBigQueryProjectId',\n\
  \  logBigQueryDatasetId: 'logBigQueryDatasetId',\n  logBigQueryTableId: 'logBigQueryTableId'\n\
  };\n\nconst requiredConsoleKeys = ['Type', 'TraceId', 'Name'];\nconst requiredBqKeys\
  \ = ['timestamp', 'type', 'trace_id', 'tag_name'];\nconst expectedBqOptions = {\
  \ ignoreUnknownValues: true };\n\nconst mockData = {\n  useOptimisticScenario: false,\n\
  \  adStorageConsent: 'optional',\n  logBigQueryProjectId: expectedBigQuerySettings.logBigQueryProjectId,\n\
  \  logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n  logBigQueryTableId:\
  \ expectedBigQuerySettings.logBigQueryTableId\n};\n\nconst setAllMockData = (objToBeMerged)\
  \ => {\n  const base = {\n    eventType: 'standard',\n    eventNameStandard: 'PageView',\n\
  \    accountId: '2222',\n    advertiserIds: [{ id: '69756' }, { id: '111111' }],\n\
  \    authUsername: 'authUsername',\n    authPassword: 'authPassword',\n    useOptimisticScenario:\
  \ false,\n  \n    autoMapServerEventDataParameters: true,\n    serverEventDataList:\
  \ [\n      { name: 'conversionTimestamp', value: '1760105481000' }\n    ],\n  \n\
  \    autoMapUserIdentifiersParameters: true,\n    userIdentifiersParametersList:\
  \ [\n      { name: 'email_sha256', value: 'test1@example.com' },\n      { name:\
  \ 'phonenumber_sha256', value: '555555555555' },\n      { name: 'email_sha256',\
  \ value: 'test2@example.net' },\n      { name: 'ip', value: '192.168.0.1' },\n \
  \     { name: 'address_sha256', value: 'test test test 123123 123123' },\n     \
  \ { name: 'mobile_id', value: 'mobileId1' },\n      { name: 'mobile_id', value:\
  \ 'mobileId2' }\n    ],\n  \n    autoMapEventParameters: true,\n    itemIdKey: '',\n\
  \    eventParametersObject: {\n      channel: 'test'  // Just to check if the merging\
  \ works.\n    },\n    eventParametersList: [\n      { name: 'amount', value: '123'\
  \ },\n      { name: 'currency', value: 'BRL' },\n      { \n        name: 'purchasedItems',\
  \ \n        value: [\n          {\n            itemId: 'SKU_12345',\n          \
  \  productName: 'Stan and Friends Tee',\n            productCategory: 'Apparel|iajsdiajsd|oasodiasd',\n\
  \            price: 10.01,\n            quantity: 3,\n          },\n          {\n\
  \            itemId: 'SKU_12346',\n            productName: \"Google Grey Women's\
  \ (Tee)\",\n            productCategory: 'Apparel|iajsdiajsd|oasodiasd',\n     \
  \       price: 21.01,\n            quantity: 2,\n          }\n        ] \n     \
  \ },\n      // { name: 'channel', value: 'Online' },\n      { name: 'storeId', value:\
  \ 'storeId' },\n      { name: 'conversionLocation.country', value: 'clCountry' },\n\
  \      { name: 'conversionLocation.state', value: 'clState' },\n      { name: 'conversionLocation.city',\
  \ value: 'clCity' },\n      { name: 'transactionId', value: 'eventId' }\n    ],\n\
  \  \n    eventCustomParametersObject:{\n      foo: 'test'  // Just to check if the\
  \ merging works.\n    },\n    eventCustomParametersList: [\n      // { name: 'foo',\
  \ value: 'bar' },\n      { name: 'abc', value: '123' }\n    ],\n  \n    adStorageConsent:\
  \ 'optional',\n    logType: 'debug',\n    bigQueryLogType: 'no',\n  };\n  \n  const\
  \ mockDataByEventType = {\n    pageLoad: {\n      eventType: 'pageLoad',\n    },\n\
  \    custom: {\n      eventType: 'custom',\n      customEventEventName: 'test',\n\
  \    }\n  };\n  \n  mergeObj(base, objToBeMerged || {});\n  mergeObj(mockData, base);\n\
  \  return mockData;\n};\n\nmock('sendHttpRequest', (requestUrl, callback, requestOptions,\
  \ requestBody) => {\n  if (typeof callback === 'function') {\n    callback(200);\n\
  \  } else {\n    requestBody = requestOptions;\n    requestOptions = callback;\n\
  \    return Promise.create((resolve, reject) => {\n      resolve({ statusCode: 200\
  \ });\n    });  \n  }\n});\n\nmock('getRequestHeader', (header) => {\n  if (header\
  \ === 'trace-id') return 'expectedTraceId';\n});\n\nconst NOW = 1747945830456;\n\
  mock('getTimestampMillis', NOW);\n\nconst EXPECTED_CACHE_KEY = 'lID+8P1zL0B7tAk477yGfW/1TitirZkv2YfvUUqElM0=';\
  \ // sha256Sync('viantcapi' + 'authUsername' + 'authPassword');\nconst EXPECTED_ACCESS_TOKEN\
  \ = 'accessToken';\nconst EXPECTED_RESPONSE_TOKEN_OBJ = { access_token: EXPECTED_ACCESS_TOKEN,\
  \ expires_in: 86400 };\nconst EXPECTED_CACHE_TOKEN_OBJ = { accessToken: EXPECTED_ACCESS_TOKEN,\
  \ expiresAt: NOW + EXPECTED_RESPONSE_TOKEN_OBJ.expires_in * 1000 * 0.9 };\n\nconst\
  \ EXPECTED_API_VERSION = '1';\nconst EXPECTED_BASE_URL = 'https://vdp-connect-api.viantinc.com/v'\
  \ + EXPECTED_API_VERSION;\nconst EXPECTED_ACCESS_TOKEN_ENDPOINT = EXPECTED_BASE_URL\
  \ + '/oauth2/authenticate';\nconst EXPECTED_CONVERSIONS_ENDPOINT = EXPECTED_BASE_URL\
  \ + '/conversions';\n"


___NOTES___

Created on 8/20/2025, 2:02:02 PM

